<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>供應商-商品</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Font Awesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.10.0/css/all.min.css" rel="stylesheet">
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../../static/CSS/style.css">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
<div class="row w-100">
  <div class="col-lg-10 col-md-12 mx-auto">
    <table id="supplierProductTable" class="table table-bordered table-striped">
      <thead>
      <button id="addSupplier" class="btn btn-success">新增供應商</button>
      <button id="deleteSelected" class="btn btn-danger">刪除選擇的供應商</button>
      <tr>
        <th><input type="checkbox" id="selectAll"></th>
        <th>供應商ID</th>
        <th>供應商名稱</th>
        <th>供應商地址</th>
        <th>聯絡人</th>
        <th>聯絡電話</th>
        <th>聯絡電子郵件</th>
        <th>總應付金額</th>
        <th>已付款金額</th>
        <th>未付款金額</th>
        <th>訂單付款細節</th>
        <th>更新</th>
      </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<!-- Modal for order details -->
<div class="modal fade" id="orderDetailsModal" tabindex="-1" aria-labelledby="orderDetailsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="orderDetailsModalLabel">訂單付款細節</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <table id="orderDetailsTable" class="table table-bordered">
          <thead>
          <tr>
            <th><input type="checkbox" id="selectAllOrders"></th>
            <th>明細ID</th>
            <th>進貨ID</th>
            <th>供應商商品ID</th>
            <th>進貨數量</th>
            <th>進貨總價格</th>
            <th>付款狀態</th>
          </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="modal-footer">
        <button id="paySelected" class="btn btn-success">一次結清所選訂單</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>
      </div>
    </div>
  </div>
</div>

<!-- Bootstrap JS and dependencies -->
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.10.2/dist/umd/popper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

<script>
  $(document).ready(function () {
    loadSuppliers();

    function loadSuppliers() {
      // Load suppliers data
      axios.get("/supplier/AllSuppliers").then(res => {
        renderTable(res.data);
      }).catch(err => {
        console.log('加載供應商資料失敗', err);
      });
    }

    function renderTable(data) {
      const tableBody = document.querySelector('#supplierProductTable tbody');
      tableBody.innerHTML = '';

      data.forEach(detail => {
        const row = document.createElement('tr');
        row.innerHTML = `
                <td><input type="checkbox" class="selectSupplier" value="${detail.supplierId}"></td>
                <td>${detail.supplierId}</td>
                <td>${detail.supplierName}</td>
                <td>${detail.address}</td>
                <td>${detail.contactPerson}</td>
                <td>${detail.phone}</td>
                <td>${detail.email}</td>
                <td>${detail.totalAmount}</td>
                <td>${detail.paidAmount}</td>
                <td>${detail.unpaidAmount}</td>
                <td><button class="btn btn-primary order-details-btn" data-supplier-id="${detail.supplierId}">訂單付款細節</button></td>
                <td><button class="btn btn-warning">更新資料</button></td>
            `;
        tableBody.appendChild(row);
      });

      // Attach click event to "訂單付款細節" buttons
      $('.order-details-btn').click(function () {
        const supplierId = $(this).data('supplier-id');
        loadOrderDetails(supplierId);
        $('#orderDetailsModal').modal('show');
      });
    }

    function loadOrderDetails(supplierId) {
      axios.get(`/supplier/${supplierId}/paymentDetails`).then(res => {
        renderOrderDetailsTable(res.data);
      }).catch(err => {
        console.log('加載訂單明細失敗', err);
      });
    }

    function renderOrderDetailsTable(data) {
      const tableBody = document.querySelector('#orderDetailsTable tbody');
      tableBody.innerHTML = '';

      data.forEach(detail => {
        const row = document.createElement('tr');
        row.innerHTML = `
                <td><input type="checkbox" class="selectOrder" value="${detail.detailId}" ${detail.paymentStatus === '已付款' ? 'disabled' : ''}></td>
                <td>${detail.detailId}</td>
                <td>${detail.restockId}</td>
                <td>${detail.supplierProductId}</td>
                <td>${detail.numberOfRestock}</td>
                <td>${detail.restockTotalPrice}</td>
                <td>${detail.paymentStatus}</td>
            `;
        tableBody.appendChild(row);
      });
    }

    // Pay selected orders
    $('#paySelected').click(function () {
      const selectedIds = [];
      $('.selectOrder:checked').each(function () {
        selectedIds.push($(this).val());
      });

      if (selectedIds.length === 0) {
        alert('請選擇要付款的訂單');
        return;
      }

      // AJAX call to pay all selected orders
      axios.post('/payments/payAll', { detailIds: selectedIds })
              .then(res => {
                alert('所選訂單已付款！');
                $('#orderDetailsModal').modal('hide');
              })
              .catch(err => {
                console.log('付款失敗', err);
              });
    });
  });
</script>
</body>
</html>
