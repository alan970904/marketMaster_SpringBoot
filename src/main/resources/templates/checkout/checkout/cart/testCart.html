<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org/">

<head>
    <meta charset="UTF-8" th:replace="~{body/headEmployee :: head}">
    <title>結帳購物車</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.10.0/css/all.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://kit.fontawesome.com/40ce2136c3.js"></script>
    <style>
        .card-img-top {
            max-height: 100%;
            width: auto;
        }

        .w20 {
            width: 20%;
        }

        .fa-file-image {
            font-size: 180px;

        }

        .h262 {
            height: 262px;
            text-align: center;
        }

        /* 購物車樣式 */
        #cartFloating {
            top: 80px !important;
            z-index: 1000;
        }

        .quantity-control {
            display: flex;
            align-items: center;
            margin: 10px 0;
        }

        .quantity-input {
            width: 60px;
            text-align: center;
            margin: 0 5px;
        }
    </style>
</head>

<body>
    <div th:replace="~{body/headerEmployee :: headerEmployee}">
        <div th:fragment="content">
            <main>
                <div class="container">
                    <div class="d-flex my-3">
                        <select class="form-select w-auto" name="" id="productCategory">
                            <option value="" selected>請選擇商品類別</option>
                            <!-- 商品種類搜尋 -->
                        </select>
                    </div>

                    <!-- 購物車浮動視窗 -->
                    <div id="cartFloating" class="position-fixed end-0 m-3 p-3 bg-white shadow rounded">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span>購物車</span>
                            <span id="cartCount" class="badge bg-primary">0</span>
                        </div>
                        <div class="border-top pt-2 mb-2">
                            總計: <span id="cartTotal">0</span> 元
                        </div>
                        <button id="checkoutBtn" class="btn btn-success w-100" disabled>
                            前往結帳
                        </button>
                    </div>

                    <div class="row invectoryCheck-row">
                    </div>

                    <div id="page">
                        <ul class="pagination" id="pageUl">
                        </ul>
                    </div>


                </div>

            </main>
        </div>
    </div>
    <div th:replace="~{body/footer :: footer}"></div>
    <script src="https://cdn.jsdelivr.net/npm/axios@1.6.7/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.js"></script>
    <script>
        // 初始化頁面
        document.addEventListener('DOMContentLoaded', init);

        // 原有的全域變數不變
        let cartItems = [];
        const cartStorage = 'marketMasterCart';

        function init() {
            fetchProductsAndRender();
            getProductCategory();
            initCart();
        }

        // 原有的商品類別和商品載入函數保持不變
        function getProductCategory() {
            axios.post('http://localhost:8080/marketMaster/product/findProductCategory')
                .then(res => {
                    categoryMaker(res.data)
                })
                .catch(err => {
                    console.error(err);
                })
        }

        function categoryMaker(data) {
            const select = document.getElementById('productCategory')
            data.forEach(element => {
                const option = document.createElement('option')
                option.value = element.productCategory
                option.textContent = element.productCategory
                document.getElementById('productCategory').appendChild(option)
                select.appendChild(option)
            });
        }

        const select = document.getElementById('productCategory');
        select.addEventListener('change', function () {
            axios.post('http://localhost:8080/marketMaster/inventoryCheck/getProductByCategory/json', {
                productCategory: this.value,
                pageSize: 10,
                pageNumber: 1
            })
                .then(res => {
                    const productsHTML = htmlMaker(res.data.content);
                    document.querySelector('.invectoryCheck-row').innerHTML = productsHTML;
                    pageMaker(res.data);
                    initializeQuantityControls();
                })
                .catch(err => {
                    console.error(err);
                })
        });

        function htmlMaker(products) {
            return products.map(product => `
        <div class="card col-3 m-3" style="width: 18rem;">
            <div class="h262 position-relative">
                ${product.productPhoto && product.productPhoto.length > 0
                    ? `<img src="/marketMaster/product/downloadProductPhoto?productId=${product.productId}" class="card-img-top">`
                    : `<i class="fa-solid fa-file-image position-absolute top-50 start-50 translate-middle"></i>`
                }
            </div>
            <div class="card-body text-center">
                <h5 class="card-title m-auto">${product.productName}</h5>
                <p class="card-text">價格: ${product.productPrice}元</p>
                <p class="card-text">庫存: ${product.numberOfInventory}個</p>
                <div class="input-group mb-3">
                    <button class="btn btn-outline-secondary decrease-quantity" type="button" 
                            data-product-id="${product.productId}">-</button>
                    <input type="number" class="form-control quantity-input" 
                           value="0" min="0" max="${product.numberOfInventory}"
                           data-product-id="${product.productId}">
                    <button class="btn btn-outline-secondary increase-quantity" type="button"
                            data-product-id="${product.productId}">+</button>
                </div>
                <button class="btn btn-primary w-100 add-to-cart"
                        data-product-id="${product.productId}"
                        data-product-name="${product.productName}"
                        data-product-price="${product.productPrice}">
                    加入購物車
                </button>
            </div>
        </div>
    `).join('');
        }

        function fetchProductsAndRender(pageNumber = 1) {
            axios.post('http://localhost:8080/marketMaster/inventoryCheck/getAllProduct/json', {
                pageSize: 10,
                pageNumber: pageNumber
            })
                .then(response => {
                    const productsHTML = htmlMaker(response.data.content);
                    document.querySelector('.invectoryCheck-row').innerHTML = productsHTML;
                    pageMaker(response.data);
                    initializeQuantityControls();
                })
                .catch(error => {
                    console.error('Error fetching products:', error);
                });
        }

        // 原有的分頁函數保持不變
        function pageMaker(data) {
            const ul = document.getElementById("pageUl");
            ul.innerHTML = '';

            for (let i = 1; i <= data.totalPages; i++) {
                const li = document.createElement("li");
                li.className = "page-item";
                const btn = document.createElement("button");
                btn.className = "page-link";
                btn.textContent = i;
                btn.addEventListener('click', () => fetchProductsAndRender(i));
                li.appendChild(btn);
                ul.appendChild(li);
            }
        }

        // 購物車相關功能
        function initCart() {
            loadCartFromStorage();
            const checkoutBtn = document.querySelector('#cartFloating button');
            checkoutBtn.addEventListener('click', proceedToCheckout);
        }

        function initializeQuantityControls() {
            // 數量減少按鈕
            document.querySelectorAll('.decrease-quantity').forEach(button => {
                button.addEventListener('click', function () {
                    const productId = this.dataset.productId;
                    const input = document.querySelector(`.quantity-input[data-product-id="${productId}"]`);
                    const currentValue = parseInt(input.value) || 0;
                    if (currentValue > 0) {
                        input.value = currentValue - 1;
                    }
                });
            });

            // 數量增加按鈕
            document.querySelectorAll('.increase-quantity').forEach(button => {
                button.addEventListener('click', function () {
                    const productId = this.dataset.productId;
                    const input = document.querySelector(`.quantity-input[data-product-id="${productId}"]`);
                    const currentValue = parseInt(input.value) || 0;
                    const maxValue = parseInt(input.max);
                    if (currentValue < maxValue) {
                        input.value = currentValue + 1;
                    }
                });
            });

            // 加入購物車按鈕
            document.querySelectorAll('.add-to-cart').forEach(button => {
                button.addEventListener('click', function () {
                    const productId = this.dataset.productId;
                    const quantity = parseInt(document.querySelector(`.quantity-input[data-product-id="${productId}"]`).value);
                    if (quantity > 0) {
                        addToCart({
                            productId: productId,
                            productName: this.dataset.productName,
                            price: parseInt(this.dataset.productPrice),
                            quantity: quantity
                        });
                    }
                });
            });
        }

        function addToCart(product) {
            const existingItemIndex = cartItems.findIndex(item => item.productId === product.productId);
            if (existingItemIndex !== -1) {
                cartItems[existingItemIndex].quantity += product.quantity;
            } else {
                cartItems.push(product);
            }
            updateCartDisplay();
            saveCartToStorage();

            // 清空輸入框
            document.querySelector(`.quantity-input[data-product-id="${product.productId}"]`).value = 0;
            alert(`已加入購物車: ${product.productName}`);
        }

        function updateCartDisplay() {
            const cartCount = document.getElementById('cartCount');
            const cartTotal = document.getElementById('cartTotal');
            const checkoutBtn = document.querySelector('#cartFloating button');

            const totalItems = cartItems.reduce((sum, item) => sum + item.quantity, 0);
            const totalAmount = cartItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);

            cartCount.textContent = totalItems;
            cartTotal.textContent = totalAmount;
            checkoutBtn.disabled = totalItems === 0;
        }

        function saveCartToStorage() {
            localStorage.setItem(cartStorage, JSON.stringify(cartItems));
        }

        function loadCartFromStorage() {
            const savedCart = localStorage.getItem(cartStorage);
            if (savedCart) {
                cartItems = JSON.parse(savedCart);
                updateCartDisplay();
            }
        }

        async function proceedToCheckout() {
            if (cartItems.length === 0) return;

            try {
                // 驗證購物車內容
                const validateResponse = await axios.post('/checkout/validate-cart', cartItems);

                if (validateResponse.data.isValid) {
                    // 獲取結帳編號和發票號碼
                    const [checkoutIdRes, invoiceNumberRes] = await Promise.all([
                        axios.get('/checkout/nextId'),
                        axios.get('/checkout/nextInvoiceNumber')
                    ]);

                    const checkoutId = checkoutIdRes.data;
                    const invoiceNumber = invoiceNumberRes.data;

                    // 構建結帳數據
                    const checkoutData = {
                        checkoutId: checkoutId,
                        invoiceNumber: invoiceNumber,
                        details: cartItems.map(item => ({
                            productId: item.productId,
                            productName: item.productName,
                            quantity: item.quantity,
                            price: item.price,
                            checkoutPrice: item.quantity * item.price
                        }))
                    };

                    // 保存到 sessionStorage
                    sessionStorage.setItem('checkoutData', JSON.stringify(checkoutData));

                    // 跳轉到結帳頁面
                    window.location.href = '/checkout/add';

                } else {
                    let errorMessage = '以下商品庫存不足：\n';
                    for (const [productId, message] of Object.entries(validateResponse.data.invalidItems)) {
                        const item = cartItems.find(i => i.productId === productId);
                        errorMessage += `${item.productName}: ${message}\n`;
                    }
                    alert(errorMessage);
                }
            } catch (error) {
                console.error('處理結帳失敗:', error);
                alert('系統錯誤，請稍後再試');
            }
        }
    </script>

</body>

</html>