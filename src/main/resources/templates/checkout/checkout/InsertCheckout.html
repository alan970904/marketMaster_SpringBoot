<!DOCTYPE html>
<html lang="zh-Hant" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8" th:replace="~{body/head :: head}">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>新增結帳記錄</title>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- DataTables CSS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css">

    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.10.0/css/all.min.css" rel="stylesheet">

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@400;500;600;700&display=swap" rel="stylesheet">

</head>

<body>
    <div th:replace="~{body/header :: header}">

        <div th:fragment="content">
            <div role="main">
                <div id="checkout" class="section section active">
                    <div class="error-message" th:if="${errorMessage}" th:text="${errorMessage}"></div>

                    <div class="card">
                        <div class="card-body">
                            <h2>新增結帳記錄</h2>

                            <form id="checkoutForm">
                                <div class="form-group mb-3">
                                    <label for="checkoutId">結帳編號:</label>
                                    <input type="text" id="checkoutId" class="form-control" readonly>
                                </div>
                                <div class="form-group mb-3">
                                    <label for="invoiceNumber">發票號碼:</label>
                                    <input type="text" id="invoiceNumber" class="form-control" readonly>
                                </div>
                                <div class="form-group mb-3">
                                    <label for="customerTel">顧客手機:</label>
                                    <input type="text" id="customerTel" class="form-control" pattern="[0-9]{10}">
                                </div>
                                <div class="form-group mb-3">
                                    <label for="employeeId">員工編號:</label>
                                    <select id="employeeId" class="form-select" required>
                                        <option value="" selected disabled>請選擇員工</option>
                                        <option th:each="emp : ${employees}" th:value="${emp.employeeId}"
                                            th:text="${emp.employeeName}"></option>
                                    </select>
                                </div>

                                <div class="form-group mb-3">
                                    <label for="checkoutDate">結帳日期:</label>
                                    <input type="date" id="checkoutDate" class="form-control" readonly>
                                </div>

                                <div class="form-group mb-3">
                                    <label>商品明細:</label>
                                    <div id="productList" class="table-responsive">
                                        <!-- JavaScript 將在此生成購物車商品表格 -->
                                    </div>
                                </div>

                                <div class="form-group mb-3">
                                    <label for="totalAmount">總結帳金額:</label>
                                    <input type="text" id="totalAmount" class="form-control" readonly>
                                </div>
                                <div id="bonusPointsSection" style="display:none">
                                    <div class="form-group mb-3">
                                        <label for="bonusPoints">紅利點數:</label>
                                        <input type="text" id="bonusPoints" class="form-control" readonly>
                                    </div>
                                    <div class="form-group mb-3">
                                        <label for="pointsDueDate">紅利點數到期日:</label>
                                        <input type="date" id="pointsDueDate" class="form-control" readonly>
                                    </div>
                                </div>

                                <div class="d-flex justify-content-between mt-4">
                                    <button type="button" class="btn btn-secondary"
                                        onclick="location.href='/marketMaster/front/cart'">
                                        返回購物
                                    </button>
                                    <button type="submit" class="btn btn-primary">新增結帳記錄</button>
                                </div>
                            </form>

                            <div id="errorMessages" class="error-message"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div th:replace="~{body/footer :: footer}"></div>
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

    <!-- Bootstrap JS Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- DataTables JS -->
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <script th:inline="javascript">
        document.addEventListener('DOMContentLoaded', async function () {
            await initCheckoutPage();
        });

        async function initCheckoutPage() {
            try {
                // 從 sessionStorage 獲取購物車資料
                const cartData = JSON.parse(sessionStorage.getItem('checkoutData'));
                if (!cartData || !cartData.items || cartData.items.length === 0) {
                    alert('購物車是空的！');
                    window.location.href = '/marketMaster/front/cart';
                    return;
                }

                // 獲取結帳編號和發票號碼
                const [checkoutIdRes, invoiceNumberRes] = await Promise.all([
                    axios.get('/marketMaster/checkout/nextId'),
                    axios.get('/marketMaster/checkout/nextInvoiceNumber')
                ]);

                // 設置基本資料
                document.getElementById('checkoutId').value = checkoutIdRes.data;
                document.getElementById('invoiceNumber').value = invoiceNumberRes.data;
                document.getElementById('checkoutDate').valueAsDate = new Date();

                // 渲染購物車商品
                renderCartItems(cartData.items);

                // 綁定事件
                document.getElementById('customerTel').addEventListener('blur', handleCustomerTelBlur);
                document.getElementById('checkoutForm').addEventListener('submit', handleCheckout);
            } catch (error) {
                console.error('初始化結帳頁面失敗:', error);
                alert('系統錯誤，請稍後再試');
            }
        }

        function renderCartItems(items) {
            const productList = document.getElementById('productList');
            let totalAmount = 0;

            if (!items || items.length === 0) {
                productList.innerHTML = '<p>購物車是空的</p>';
                return;
            }

            const tableHtml = `
            <table class="table">
                <thead>
                    <tr>
                        <th>商品名稱</th>
                        <th>數量</th>
                        <th>單價</th>
                        <th>小計</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                    ${items.map(item => {
                const subtotal = item.price * item.quantity;
                totalAmount += subtotal;
                return `
                            <tr>
                                <td>${item.productName}</td>
                                <td>
                                    <button onclick="updateQuantity('${item.productId}', -1)">-</button>
                                    ${item.quantity}
                                    <button onclick="updateQuantity('${item.productId}', 1)">+</button>
                                </td>
                                <td>${item.price}</td>
                                <td>${subtotal}</td>
                                <td><button onclick="removeItem('${item.productId}')">刪除</button></td>
                            </tr>
                        `;
            }).join('')}
                </tbody>
                <tfoot>
                    <tr>
                        <td colspan="3" class="text-end fw-bold">總計：</td>
                        <td class="fw-bold">${totalAmount}</td>
                    </tr>
                </tfoot>
            </table>
        `;

            productList.innerHTML = tableHtml;
            document.getElementById('totalAmount').value = totalAmount;
        }

        function updateQuantity(productId, change) {
            const cartData = JSON.parse(sessionStorage.getItem('checkoutData'));
            const item = cartData.items.find(i => i.productId === productId);
            if (item) {
                item.quantity += change;
                if (item.quantity <= 0) {
                    cartData.items = cartData.items.filter(i => i.productId !== productId);
                }
            }
            sessionStorage.setItem('checkoutData', JSON.stringify(cartData));
            renderCartItems(cartData.items);
        }

        function removeItem(productId) {
            const cartData = JSON.parse(sessionStorage.getItem('checkoutData'));
            cartData.items = cartData.items.filter(i => i.productId !== productId);
            sessionStorage.setItem('checkoutData', JSON.stringify(cartData));
            renderCartItems(cartData.items);
        }

        async function handleCustomerTelBlur(event) {
            const customerTel = event.target.value.trim();
            const bonusPointsSection = document.getElementById('bonusPointsSection');

            if (customerTel && /^[0-9]{10}$/.test(customerTel)) {
                try {
                    const response = await axios.get(`/marketMaster/customer/check/${customerTel}`);
                    if (response.data.exists) {
                        const totalAmount = parseInt(document.getElementById('totalAmount').value);
                        const bonusPoints = Math.floor(totalAmount / 100);

                        const dueDate = new Date();
                        dueDate.setFullYear(dueDate.getFullYear() + 1);

                        document.getElementById('bonusPoints').value = bonusPoints;
                        document.getElementById('pointsDueDate').valueAsDate = dueDate;
                        bonusPointsSection.style.display = 'block';
                    } else {
                        bonusPointsSection.style.display = 'none';
                    }
                } catch (error) {
                    console.error('檢查會員失敗:', error);
                    bonusPointsSection.style.display = 'none';
                }
            } else {
                bonusPointsSection.style.display = 'none';
            }
        }

        async function handleCheckout(event) {
            event.preventDefault();

            try {
                const cartData = JSON.parse(sessionStorage.getItem('checkoutData'));
                if (!cartData || !cartData.items || cartData.items.length === 0) {
                    alert('購物車資料錯誤，請重新嘗試');
                    window.location.href = '/marketMaster/front/cart';
                    return;
                }

                const formData = {
                    checkoutId: document.getElementById('checkoutId').value,
                    customerTel: document.getElementById('customerTel').value,
                    employeeId: document.getElementById('employeeId').value,
                    items: cartData.items.map(item => ({
                        productId: item.productId,
                        quantity: item.quantity,
                        price: item.price
                    }))
                };

                const response = await axios.post('/marketMaster/front/cart/add-checkout', formData);

                if (response.data.status === 'success') {
                    alert('結帳成功！');
                    sessionStorage.removeItem('checkoutData');
                    window.location.href = '/marketMaster/checkout/list';
                } else {
                    alert(response.data.message || '結帳失敗，請稍後再試');
                }
            } catch (error) {
                console.error('結帳失敗:', error);
                alert('系統錯誤，請稍後再試');
            }
        }
    </script>
</body>

</html>